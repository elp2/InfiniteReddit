
<!doctype html>
<html>
  <head>
    <meta charset=utf-8>
    <title>Infinite Reddit</title>
  </head>
  <body>
    <script type=text/javascript src=underscore.js></script>

    <script type=text/javascript src=jquery-1.8.0.js></script>
    <script type=text/javascript src=infinity.js></script>
    <script type=text/javascript src=reddit.js></script>
    <link rel=stylesheet type=text/css href=reddit.css>

    <div class='container main-container'> 
      <div id=demo class=row>
        <div class=span4>
          <div class=row-fluid>
            <div class='list-view'>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script type=text/html id=spinner-template>
      <div class=row>
        <div class=span12 style="background-color:#f00"> Loading more images...
          <img src=spinner.gif class=spinner alt='Loading...'>
        </div>
      </div>
    </script>

    <!-- NOTE: <P></P> at the beginning/end outside of div end up screwing up the spinner -->
    <script type=text/html id=image-template>
      <div class='reddit-image'>
        <h4>{{title}}</h4>
        <div class='reddit-image-about'>
        By <div class='image-author'>{{ author }}</div> at <div class='image-created'>{{ created }} on <div class='image-subreddit'>{{ subreddit}}</div>
        </div>
        <img src={{ url }} width={{ scaledWidth }} height={{ scaledHeight }}/>
      </div>
    </script>

<script type=text/javascript>
$(document).ready(function(){
  var $el = $('#demo');
  var listView = new infinity.ListView($el);

  templateSettings = {
    interpolate : /\{\{(.+?)\}\}/g
  };
  imageTemplate = _.template($('#image-template').html(), false, templateSettings );//false, { interpolate : /\{\{(.+?)\}\}/g } );

  !function() {

    var spinnerTemplate = _.template($('#spinner-template').html());

    var spinner = $(spinnerTemplate());
    var updateScheduled = false;
    function onscreen($el) {
      var viewportBottom = $(window).scrollTop() + $(window).height();
      console.log( "vbp: ", viewportBottom, " <= eloffset.top", $el.offset().top, " = ", $el.offset().top <= viewportBottom )
      isOnscreen = $el.offset().top <= viewportBottom;
      return isOnscreen;
    }

    spinner.insertAfter($('#demo').closest('.row'));
    $(window).on('scroll', function() {
      if(!updateScheduled) {
        setTimeout(function() {
          if(onscreen(spinner)) {
            getReddits( reddits, listView )
            // if the spinner is visible them presumably you've reached the bottom of the page
          }

          updateScheduled = false;
        }, 500);
        updateScheduled = true;
      }
    });
  }();

function getSubreddits() {  
  reddits = window.location.toString().split("?")[1];
  if(undefined == reddits )
    return(["all"])
  return(reddits.split("+"))
}

//TODO: remove when offline done
setTimeout(function(){ 
reddits = getSubreddits();
getReddits( reddits, listView)
}, 500);

// end document ready
 });
</script>
</body>
</html>
