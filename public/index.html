
<!doctype html>
<html>
  <head>
    <meta charset=utf-8>
    <title>Infinite Reddit</title>
    <link rel=stylesheet type=text/css href=reddit.css>
    <link rel=stylesheet type=text/css href=css/bootstrap.css>
    <link rel=stylesheet type=text/css href=css/font-awesome.css><!-- Font Awesome - http://fortawesome.github.com/Font-Awesome -->
  </head>
  <body>
    <script type=text/javascript src=underscore.js></script>

    <script type=text/javascript src=jquery-1.8.0.js></script>
    <script type=text/javascript src=infinity.js></script>
    <script type=text/javascript src=reddit.js></script>


    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="./index.html">âˆž.r</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="">
                <a href="">r/all - r/starcraft - r/whatever</a>
              </li>
            </ul>
          </div>
        <ul class="nav pull-right">
          <li>
            <a href="settings"><i class="icon-cogs"></i>Settings</a>
          </li>
          <li>
            <a href="settings"><i class="icon-info-sign"></i>About</a>
          </li>
        </ul>
        </div>
      </div>
    </div>
    <div class='container main-container'> 
      <div id=images class=row>
        <div class=span4>
          <div class=row-fluid>
            <div class='list-view'>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script type=text/html id=spinner-template>
      <div class='spinner-template'>
        Loading more images...
        <img src=spinner.gif class=spinner alt='Loading...' width=16 height=16>
      </div>
    </script>

    <!-- NOTE: <P></P> at the beginning/end outside of div end up screwing up the spinner -->
    <!-- TODO: Author flair/links -->
    <script type=text/html id=image-template>
      <div class='reddit-image'>
        <h3>{{ title }}</h3>         
        <div class='reddit-image-scoretag'>        
          <div class='reddit-image-score'>{{ score }}</div>
          <div class='reddit-image-ups'>{{ ups }}</div>
          <div class='reddit-image-downs'>{{ downs }}</div>
        </div>
        <p class='reddit-image-about'>
        By {{ author }} at {{ created }} on {{ subreddit }}
        </p>
        <img src={{ url }} width={{ scaledWidth }} height={{ scaledHeight }}/>
      </div>
    </script>

<script type=text/javascript>
$(document).ready(function(){
  var $el = $('#images');
  var listView = new infinity.ListView($el);

  var templateSettings = { interpolate : /\{\{(.+?)\}\}/g };
  imageTemplate = _.template($('#image-template').html(), false, templateSettings );

  picFetcher = new reddit.PicFetcher(listView, { onlineMode : window.location.toString().substring(0,4) == "http" })
  picFetcher.setSubreddits(getSubreddits());
  picFetcher.getMorePosts();


    /* should be in the ListView 

        var scaledWidth = this.width;
      var maxWidth = $(window).width() - 30
      img.scaledWidth = Math.min(maxWidth, this.width);
      img.scaledHeight = this.height * ( img.scaledWidth / this.width );

      var imageDiv = imageTemplate(img);
      var listItem = listView.append($(imageDiv));
      self.setSeenURL(img.url); // TODO: only call this when it's shown as our active image
      if(self.autoScrollToNext) {
        self.autoScrollToNext = false;        
          window.scrollTo( 0, listItem.$el.offset().top);
      }
      */

  !function() {
    var spinner = $($('#spinner-template').html());
    var updateScheduled = false;

    spinner.insertAfter($('#images').closest('.row'));

    function onscreen($el) {
      var viewportBottom = $(window).scrollTop() + $(window).height();
      return  $el.offset().top <= viewportBottom;
    }

    $(window).on('scroll', function() {
      if(!updateScheduled) {
        setTimeout(function() {
          if(onscreen(spinner)) { 
            picFetcher.getMorePosts(true);       
          }
          updateScheduled = false;
        }, 500);
        updateScheduled = true;
      }
    });
  }();

function getSubreddits() {  
  var reddits = window.location.toString().split("?")[1];
  if(undefined == reddits )
    return(["all"])
  return(reddits.split("+"))
}
// end document ready
 });


$(document).keydown(function(event) {
  var jCode = 74, kCode = 75, aCode = 65, sCode = 83, dCode = 68;
  switch(event.which) {
    case jCode:
    case aCode:
      picFetcher.advance(1);
      break;

    case kCode:
    case sCode:
      picFetcher.advance(-1);
      break;

    case dCode:
      picFetcher.debug();
      break;

    break;
  }
//console.log(event);
});

</script>
</body>
</html>
