<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<title>âˆž.r</title>
	<link href="style.css" rel="stylesheet" type="text/css">
	<script type="text/javascript" src="swipeview.js"></script>
	<script type="text/javascript" src="jquery-1.8.0.js"></script>
    <script type=text/javascript src=reddit.js></script>
</head>

<body>
	<div id="wrapper"></div>
	
<script type="text/javascript">

document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);

var	gallery,
	el,
	i,
	page,
	slides = [
	];

gallery = new SwipeView('#wrapper', { numberOfPages: slides.length, loop: false});

// Load initial data
for (i=0; i<3; i++) {
	page = i==0 ? slides.length-1 : i-1;
	// TODO: switch to templating
	el = document.createElement('img');
	el.className = 'loading';
	el.src = "";
	el.width = 250;
	el.height = 250;
	el.onload = function () { this.className = ''; }
	gallery.masterPages[i].appendChild(el);

	el = document.createElement('span');
	el.innerHTML = "";
	gallery.masterPages[i].appendChild(el);
}

function putSlideAt(upcoming, i) {
	var slide = slides[upcoming] ? slides[upcoming] : {url:"", width:250, height:250, desc: ""};
	el = gallery.masterPages[i].querySelector('img');
	el.className = 'loading';
	el.src = slide.url;
	el.width = slide.width;
	el.height = slide.height;
	
	el = gallery.masterPages[i].querySelector('span');
	el.innerHTML = slide.desc;
}

gallery.onFlip(function () {
	var el,
		upcoming,
		i;

	for (i=0; i<3; i++) {
		upcoming = gallery.masterPages[i].dataset.upcomingPageIndex;

		if (upcoming != gallery.masterPages[i].dataset.pageIndex) {
			putSlideAt(upcoming,i);
		}
	}
});

gallery.onMoveOut(function () {
	console.log("onMoveOut");
	gallery.masterPages[gallery.currentMasterPage].className = gallery.masterPages[gallery.currentMasterPage].className.replace(/(^|\s)swipeview-active(\s|$)/, '');
});

gallery.onMoveIn(function () {
	console.log("onMoveIn");
	var className = gallery.masterPages[gallery.currentMasterPage].className;
	/(^|\s)swipeview-active(\s|$)/.test(className) || (gallery.masterPages[gallery.currentMasterPage].className = !className ? 'swipeview-active' : className + ' swipeview-active');
});

$(document).keydown(function(event) {
  var jCode = 74, kCode = 75, aCode = 65, sCode = 83, dCode = 68, spaceCode = 32;
  switch(event.which) {
    case jCode:
    case aCode:
      picFetcher.getMorePosts(); // TODO: rely on throttling for now.  Find a better way!
      if( !gallery.next() ) {
      	// TODO: Show some kind of loading screen... maybe let it advance 1 and then replace it as the image comes in
      }
      break;

    case kCode:
    case sCode:
      gallery.prev();
      break;

    case dCode:
    // Debugging
      break;

      case spaceCode:
      	// TODO: advance down the image if it's super tall, advance to next if we're at the bottom / it was already visible
      break;
    break;
  }
});

var firstImages = 0;
$(document).ready(function(){
	function addImage( img, w, h, advanceToNext ) {
		var el, 
			newPageI = gallery.options.numberOfPages;

		gallery.updatePageCount(newPageI + 1);
		slides.push({url:img.url, width:w, height:h, desc:img.title});		

		// Special case to get the first images out there.  
		if(1 == firstImages) {
			putSlideAt(1,2);
			firstImages++;
		} else if(0==firstImages){
			putSlideAt(0,1);
			firstImages++;
		}
	};

  var onlineMode = window.location.toString().substring(0,4) == "http" || window.location.toString().split("#")[1] != "test";
  picFetcher = new reddit.PicFetcher(gallery, { onlineMode: onlineMode, imgFn: addImage  })
  picFetcher.setSubreddits(getSubreddits());

  function getit() { picFetcher.getMorePosts()};
  setTimeout( getit, 100 );

function getSubreddits() {  
  var reddits = window.location.toString().split("?")[1];
  if(undefined == reddits )
    return(["all"])
  return(reddits.split("+"))
}
// end document ready
 });

</script>
</body>
</html>