<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<title>âˆž.r</title>
	<link href="style.css" rel="stylesheet" type="text/css">
	<script type="text/javascript" src="swipeview.js"></script>
	<script type="text/javascript" src="jquery-1.8.0.js"></script>
    <script type=text/javascript src=reddit.js></script>
</head>

<body>
	<div id="wrapper"></div>
	
<script type="text/javascript">

document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);

var	gallery,
	el,
	i,
	page,
	slides = [
		{
			url: 'images/pic06.jpg',
			width: 300,
			height: 1500,
			desc: 'Leaning tower, Pisa, Italy'
		},	
		{
			url: 'images/pic01.jpg',
			width: 300,
			height: 213,
			desc: 'Piazza del Duomo, Florence, Italy'
		},
		{
			url: 'images/pic02.jpg',
			width: 300,
			height: 164,
			desc: 'Tuscan Landscape'
		},/*
		{
			url: 'images/pic03.jpg',
			width: 300,
			height: 213,
			desc: 'Colosseo, Rome, Italy'
		},
		{
			url: 'images/pic04.jpg',
			width: 147,
			height: 220,
			desc: 'Somewhere near Chinatown, San Francisco'
		},
		{
			url: 'images/pic05.jpg',
			width: 300,
			height: 213,
			desc: 'Medieval guard tower, Asciano, Siena, Italy'
		},*/
	];

gallery = new SwipeView('#wrapper', { numberOfPages: slides.length, loop: false});

// Load initial data
for (i=0; i<3; i++) {
	page = i==0 ? slides.length-1 : i-1;
	el = document.createElement('img');
	el.className = 'loading';
	el.src = "";
	el.width = 250;
	el.height = 250;
	el.onload = function () { this.className = ''; }
	gallery.masterPages[i].appendChild(el);

	el = document.createElement('span');
	el.innerHTML = "Loading: " + i + "";
	gallery.masterPages[i].appendChild(el);
}
/*
setTimeout( function() {  			
i=1;
			el = gallery.masterPages[i].querySelector('img');
			el.className = 'loading';
			el.src = "images/pic06.jpg"
			el.width = 300;
			el.height = 1500;

	el = gallery.masterPages[i].querySelector('span');
	console.log("EL: ", el, " ih", el.innerHTML);
			el.innerHTML = "TEST!";
}, 1000 );
*/

gallery.onFlip(function () {
	var el,
		upcoming,
		i;

	for (i=0; i<3; i++) {
		upcoming = gallery.masterPages[i].dataset.upcomingPageIndex;

		if (upcoming != gallery.masterPages[i].dataset.pageIndex) {
			el = gallery.masterPages[i].querySelector('img');
			el.className = 'loading';
			el.src = slides[upcoming].url;
			el.width = slides[upcoming].width;
			el.height = slides[upcoming].height;
			
			el = gallery.masterPages[i].querySelector('span');
			el.innerHTML = slides[upcoming].desc;
		}
	}
	
	//document.querySelector('#nav .selected').className = '';
});

gallery.onMoveOut(function () {
	console.log("onMoveOut");
	gallery.masterPages[gallery.currentMasterPage].className = gallery.masterPages[gallery.currentMasterPage].className.replace(/(^|\s)swipeview-active(\s|$)/, '');
});

gallery.onMoveIn(function () {
	console.log("onMoveIn");
	var className = gallery.masterPages[gallery.currentMasterPage].className;
	/(^|\s)swipeview-active(\s|$)/.test(className) || (gallery.masterPages[gallery.currentMasterPage].className = !className ? 'swipeview-active' : className + ' swipeview-active');
});

$(document).keydown(function(event) {
  var jCode = 74, kCode = 75, aCode = 65, sCode = 83, dCode = 68;
  switch(event.which) {
    case jCode:
    case aCode:
      picFetcher.getMorePosts(); // TODO: rely on throttling for now.  Find a better way!

      gallery.next();
      break;

    case kCode:
    case sCode:
//      picFetcher.getMorePosts();

      gallery.prev();
      break;

    case dCode:
      break;

    break;
  }
});

$(document).ready(function(){
	function addImage( img, w, h, advanceToNext ) {
		var el, 
			newPageI = gallery.options.numberOfPages;

		console.log("Adding: ", img.url, "@", newPageI, w, "x", h);

		gallery.updatePageCount(newPageI + 1);
		slides.push({url:img.url, width:w, height:h, desc:img.title});
	};

  var onlineMode = true; //  window.location.toString().substring(0,4) == "http";
  picFetcher = new reddit.PicFetcher(gallery, { onlineMode: onlineMode, imgFn: addImage  })
  picFetcher.setSubreddits(getSubreddits());
  picFetcher.getMorePosts();

function getSubreddits() {  
  var reddits = window.location.toString().split("?")[1];
  if(undefined == reddits )
    return(["all"])
  return(reddits.split("+"))
}
// end document ready
 });

</script>
</body>
</html>